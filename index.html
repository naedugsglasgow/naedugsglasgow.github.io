<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nae Dugs Glasgow</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .legend {
    background-color: white;
    border-radius: 5px;
    bottom: 30px;
    padding: 10px;
    font-family: sans-serif;
    position: absolute;
    left: 10px;
    font-size: 13px;
    line-height: 18px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    max-width: 220px;
  }
  .legend div { display: flex; align-items: center; margin-bottom: 4px; }
  .legend span {
    display: inline-block;
    width: 14px; height: 14px;
    margin-right: 6px;
    border-radius: 50%;
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="legend" class="legend"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmFlZHVnc2dsYXNnb3ciLCJhIjoiY21lM2F4ZXJqMDVqcjJpczc4OXlhd2NjaiJ9.x89RmWhqtd4qR_GKMTYccA';

// Airtable CSV export link
const airtableCSV = 'https://airtable.com/appJKCKuw6zmTZvYB/shrQDXpd8BzgOGIzr?output=csv';

// Policy → colour mapping (for pin colours)
const policyColors = {
    'Dog-free indoors': '#00aa00',          // Green
    'Assistance dogs only': '#00aa00',      // Green
    'Designated pet-free area': '#ffbf00',  // Amber
    'Curfew on dogs': '#ffbf00',            // Amber
    'Dogs on leads': '#ffbf00',             // Amber
    'Dog-friendly': '#ff0000'               // Red
};

// Venue Type → icon mapping (you must add these PNG files in your repo)
const venueIcons = {
    'Cafe': 'cafe.png',               // Light blue
    'Pub': 'pub.png',                 // Turquoise
    'Bar': 'bar.png',                 // Light green
    'Outdoors': 'outdoors.png',       // Light orange
    'Sightseeing': 'sightseeing.png', // Light pink
    'Things to do': 'thingstodo.png', // Light purple
    'Activity': 'activity.png',       // Rose
    'Venue': 'venue.png'              // Purple
};

// Venue Type colours for legend
const venueTypeColors = {
    'Cafe': '#add8e6',          // Light blue
    'Pub': '#40e0d0',           // Turquoise
    'Bar': '#90ee90',           // Light green
    'Outdoors': '#ffcc99',      // Light orange
    'Sightseeing': '#ffb6c1',   // Light pink
    'Things to do': '#c8a2c8',  // Light purple
    'Activity': '#ff007f',      // Rose
    'Venue': '#800080'          // Purple
};

// Build legend
function buildLegend() {
    const legend = document.getElementById('legend');
    legend.innerHTML = '<strong>Policy Colours</strong>';
    Object.entries(policyColors).forEach(([policy, color]) => {
        const item = document.createElement('div');
        const colorBox = document.createElement('span');
        colorBox.style.backgroundColor = color;
        item.appendChild(colorBox);
        item.appendChild(document.createTextNode(policy));
        legend.appendChild(item);
    });

    legend.innerHTML += '<br><strong>Venue Type Icons</strong>';
    Object.entries(venueTypeColors).forEach(([type, color]) => {
        const item = document.createElement('div');
        const colorBox = document.createElement('span');
        colorBox.style.backgroundColor = color;
        item.appendChild(colorBox);
        item.appendChild(document.createTextNode(type));
        legend.appendChild(item);
    });
}

fetch(airtableCSV)
  .then(res => res.text())
  .then(csvText => {
    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    const data = parsed.data;

    const features = data.map(row => {
        const lat = parseFloat(row.Latitude);
        const lon = parseFloat(row.Longitude);
        if (isNaN(lat) || isNaN(lon)) return null;

        const venueType = venueIcons[row['Venue Type']] ? row['Venue Type'] : 'Venue';
        const policy = row.Policy in policyColors ? row.Policy : 'Dog-friendly';

        return {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [lon, lat]
            },
            properties: {
                name: row.Name,
                venueType: venueType,
                address: row.Address,
                policy: policy,
                link: row.Link,
                color: policyColors[policy],
                icon: venueIcons[venueType]
            }
        };
    }).filter(Boolean);

    const geojson = { type: 'FeatureCollection', features };

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-4.2518, 55.8642], // Glasgow
        zoom: 12
    });

    map.on('load', () => {
        // Load all venue icons
        const iconPromises = Object.values(venueIcons).map(icon =>
            new Promise(resolve => {
                map.loadImage(icon, (error, image) => {
                    if (error) throw error;
                    map.addImage(icon, image);
                    resolve();
                });
            })
        );

        Promise.all(iconPromises).then(() => {
            map.addSource('venues', { type: 'geojson', data: geojson });

            map.addLayer({
                id: 'venue-points',
                type: 'symbol',
                source: 'venues',
                layout: {
                    'icon-image': ['get', 'icon'],
                    'icon-size': 0.8,
                    'icon-allow-overlap': true
                },
                paint: {
                    'icon-color': ['get', 'color']
                }
            });

            // Popups
            map.on('click', 'venue-points', e => {
                const p = e.features[0].properties;
                new mapboxgl.Popup()
                    .setLngLat(e.features[0].geometry.coordinates)
                    .setHTML(`
                        <strong>${p.name}</strong><br>
                        ${p.venueType}<br>
                        ${p.address}<br>
                        <em>${p.policy}</em><br>
                        <a href="${p.link}" target="_blank">More Info</a>
                    `)
                    .addTo(map);
            });

            map.on('mouseenter', 'venue-points', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'venue-points', () => map.getCanvas().style.cursor = '');

            buildLegend();
        });
    });
});
</script>

</body>
</html>
