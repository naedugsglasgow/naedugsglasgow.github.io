<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nae Dugs Glasgow</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
// ====== SETTINGS ======
const MAPBOX_TOKEN = 'pk.eyJ1IjoibmFlZHVnc2dsYXNnb3ciLCJhIjoiY21lM2F4ZXJqMDVqcjJpczc4OXlhd2NjaiJ9.x89RmWhqtd4qR_GKMTYccA';
const AIRTABLE_SHARE_URL = 'https://airtable.com/appJKCKuw6zmTZvYB/shr1lUkLBb1XFaVHp';

// Colour maps
const venueTypeColors = {
  'Cafe': '#ADD8E6',
  'Pub': '#40E0D0',
  'Bar': '#90EE90',
  'Outdoors': '#FFA07A',
  'Sightseeing': '#FFB6C1',
  'Things to do': '#9370DB',
  'Activity': '#FFC0CB',
  'Venue': '#800080'
};

const policyColors = {
  'Dog-free indoors': '#008000',
  'Assistance dogs only': '#008000',
  'Designated pet-free area': '#FFBF00',
  'Curfew on dogs': '#FFBF00',
  'Dogs on leads': '#FFBF00',
  'Dog-friendly': '#FF0000'
};

// ====== MAP SETUP ======
mapboxgl.accessToken = MAPBOX_TOKEN;
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  center: [-4.2518, 55.8642],
  zoom: 12
});

// ====== FETCH + PARSE ======
// Airtable shared views are HTML tables. We'll fetch and parse.
async function loadAirtableData() {
  const proxy = 'https://api.allorigins.win/raw?url=';
  const encoded = encodeURIComponent(AIRTABLE_SHARE_URL);
  const res = await fetch(proxy + encoded);
  const html = await res.text();

  // Create DOM from HTML string
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  const rows = [...doc.querySelectorAll('table tbody tr')];
  const data = rows.map(row => {
    const cells = row.querySelectorAll('td');
    return {
      Name: cells[0]?.innerText.trim(),
      'Venue Type': cells[1]?.innerText.trim(),
      Address: cells[2]?.innerText.trim(),
      Latitude: parseFloat(cells[3]?.innerText.trim()),
      Longitude: parseFloat(cells[4]?.innerText.trim()),
      Policy: cells[5]?.innerText.trim(),
      Link: cells[6]?.innerText.trim()
    };
  });

  plotData(data);
}

function plotData(records) {
  records.forEach(fields => {
    if (!fields.Latitude || !fields.Longitude) return;

    const popupHTML = `
      <h3>${fields.Name || ''}</h3>
      <p><b>Venue Type:</b> <span style="color:${venueTypeColors[fields['Venue Type']] || '#000'}">${fields['Venue Type'] || ''}</span></p>
      <p><b>Address:</b> ${fields.Address || ''}</p>
      <p><b>Policy:</b> ${fields.Policy || ''}</p>
      ${fields.Link ? `<p><a href="${fields.Link}" target="_blank">More info</a></p>` : ''}
    `;

    new mapboxgl.Marker({ color: policyColors[fields.Policy] || '#000' })
      .setLngLat([fields.Longitude, fields.Latitude])
      .setPopup(new mapboxgl.Popup().setHTML(popupHTML))
      .addTo(map);
  });
}

// Load data
loadAirtableData();
</script>
</body>
</html>
